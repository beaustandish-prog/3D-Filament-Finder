<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Filament Finder - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spool-card-top {
            clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-gray-800 p-4 shadow-md border-b border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <h1
                class="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400 whitespace-nowrap">
                Filament Finder
            </h1>

            <!-- Filters -->
            <div class="flex flex-wrap gap-2 w-full lg:w-auto items-center justify-center">
                <input type="text" id="search-input" placeholder="Search..."
                    class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 focus:border-blue-500 outline-none w-full sm:w-32 md:w-48">

                <div class="flex gap-2 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0">
                    <select id="filter-brand"
                        class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 outline-none flex-1 sm:flex-none">
                        <option value="">All Brands</option>
                        {% for b in brands %}
                        <option value="{{ b }}">{{ b }}</option>
                        {% endfor %}
                    </select>

                    <select id="filter-material"
                        class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 outline-none flex-1 sm:flex-none">
                        <option value="">All Types</option>
                        {% for m in materials %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>

                    <select id="filter-color"
                        class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 outline-none flex-1 sm:flex-none">
                        <option value="">All Colors</option>
                        {% for c in colors %}
                        <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Action Buttons - Responsive Wrapping -->
            <div class="flex flex-wrap gap-2 w-full md:w-auto items-center justify-center">
                <a href="/scan"
                    class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    üì± Scan Box
                </a>
                <a href="/add"
                    class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    ‚úèÔ∏è Add Manually
                </a>
                <button onclick="clearAll()"
                    class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    üóëÔ∏è Delete All
                </button>
                <button id="combine-mode-btn" onclick="toggleCombineMode()"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    üîó Combine
                </button>

                <!-- History and Logout Buttons -->
                <a href="/history"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    üìä History
                </a>
                <span class="text-xs text-gray-400 hidden lg:block">{{ user_email }}</span>
                <a href="/logout"
                    class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm whitespace-nowrap">
                    üö™ Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Inventory Grid (Main Content) -->
        <div class="w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold flex items-center">
                    <span class="bg-gray-700 p-2 rounded-lg mr-2">üì¶</span> Inventory
                </h2>
                <span id="result-count" class="text-gray-400 text-sm"></span>
            </div>

            {% if not inventory %}
            <div class="bg-gray-800 rounded-xl p-8 text-center border-2 border-dashed border-gray-700">
                <p class="text-gray-400 mb-4">No spools found.</p>
                <a href="/scan" class="text-blue-400 hover:text-blue-300 underline">Scan your first spool</a>
            </div>
            {% else %}
            <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for item in inventory %}
                <!-- Card -->
                <div class="spool-card bg-gray-800 rounded-xl overflow-hidden shadow-lg transform hover:-translate-y-1 transition duration-200 group cursor-pointer"
                    onclick='openModal({{ item.to_dict()|tojson }})' data-brand="{{ item.brand }}"
                    data-material="{{ item.material }}" data-color="{{ item.color_name }}">

                    <!-- Color Preview Header -->
                    <div class="h-32 w-full spool-card-top relative" style="background-color: {{ item.color_hex }};">
                        <!-- Combine Mode Checkbox -->
                        <div class="absolute top-2 left-2 combine-checkbox hidden z-10">
                            <input type="checkbox"
                                class="spool-checkbox w-5 h-5 rounded border-2 border-white cursor-pointer"
                                data-spool-id="{{ item.id }}" onclick="event.stopPropagation(); updateSelection(this)">
                        </div>

                        <div class="absolute bottom-2 left-4 text-white drop-shadow-md font-bold text-lg"
                            style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                            {{ item.material }}
                        </div>
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <span class="bg-black/50 px-2 py-1 rounded text-xs text-white">{{ item.weight_remaining_g
                                }}g</span>
                            {% if item.quantity > 1 %}
                            <span class="bg-green-600 px-2 py-1 rounded text-xs text-white font-bold">x{{ item.quantity
                                }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg leading-tight">{{ item.brand }}</h3>
                                <p class="text-sm text-gray-400">{{ item.color_name }}</p>
                            </div>
                            {% if item.image_path %}
                            <img src="/{{ item.image_path }}"
                                class="w-10 h-10 rounded object-cover border border-gray-600 transition-transform group-hover:scale-110">
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-400 mt-4 border-t border-gray-700 pt-3">
                            <div>
                                <span class="block text-gray-500">Diameter</span>
                                {{ item.diameter }}mm
                            </div>
                            <div>
                                <span class="block text-gray-500">Temp</span>
                                {{ item.temp_nozzle }}¬∞C
                            </div>
                            <div class="col-span-2">
                                <span class="block text-gray-500">Location</span>
                                {{ item.location or 'Unassigned' }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Combine Mode Action Bar -->
    <div id="combine-action-bar" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 
         bg-purple-600 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center space-x-4 z-50">
        <span id="selected-count">0 spools selected</span>
        <button onclick="combineSelected()"
            class="bg-white text-purple-600 px-4 py-2 rounded font-semibold hover:bg-gray-100 transition">
            Combine Selected
        </button>
        <button onclick="cancelCombine()" class="text-white hover:text-gray-200 transition">
            Cancel
        </button>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-gray-800 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto flex flex-col md:flex-row shadow-2xl relative">

            <!-- Close Button -->
            <button onclick="closeModal()"
                class="absolute top-4 right-4 bg-black/50 text-white rounded-full p-2 hover:bg-black/70 z-10">
                ‚úñ
            </button>

            <!-- Image Section -->
            <div class="w-full md:w-1/2 bg-black flex items-center justify-center p-2 relative group">
                <img id="modal-img" src=""
                    class="max-h-[60vh] md:max-h-full object-contain transition-transform duration-300 cursor-zoom-in"
                    onclick="toggleZoom(this)">
                <p
                    class="absolute bottom-4 text-xs text-gray-400 bg-black/50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                    Click to Zoom</p>
            </div>

            <!-- Details Section -->
            <div class="w-full md:w-1/2 p-8 space-y-6">
                <div>
                    <h2 id="modal-brand"
                        class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                        Brand</h2>
                    <p id="modal-material-color" class="text-xl text-gray-300">Material - Color</p>
                    <div id="modal-code" class="text-sm font-mono text-yellow-500 mt-1"></div>
                </div>

                <div class="grid grid-cols-2 gap-6 text-sm">
                    <div class="bg-gray-700/50 p-3 rounded-lg">
                        <span class="block text-gray-500 mb-1">Weight</span>
                        <span id="modal-weight" class="text-xl font-bold">1000g</span>
                        <span class="text-xs text-gray-400"> / 1000g</span>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded-lg">
                        <span class="block text-gray-500 mb-1">Quantity</span>
                        <span id="modal-qty" class="text-xl font-bold">x1</span>
                    </div>
                </div>

                <div class="space-y-2 text-gray-300 border-t border-gray-700 pt-4">
                    <p><span class="text-gray-500 w-24 inline-block">Diameter:</span> <span
                            id="modal-diameter">1.75mm</span></p>
                    <p><span class="text-gray-500 w-24 inline-block">Temp:</span> <span id="modal-temp">200-220¬∞C</span>
                    </p>
                    <p><span class="text-gray-500 w-24 inline-block">Location:</span> <span
                            id="modal-location">Unassigned</span></p>
                    <p><span class="text-gray-500 w-24 inline-block">Added:</span> <span id="modal-date"></span></p>
                </div>

                <!-- Action Buttons -->
                <div class="pt-4 flex justify-between">
                    <button onclick="consumeSpool()"
                        class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                        Mark 1 Spool as Used
                    </button>
                    <button onclick="deleteCurrentItem()"
                        class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                        üóëÔ∏è Delete Spool
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentItemId = null;

        // --- Clear All Logic ---
        async function clearAll() {
            if (confirm("‚ö†Ô∏è ARE YOU SURE?\n\nThis will PERMANENTLY DELETE all inventory items.\nThis action cannot be undone.")) {
                const res = await fetch('/api/inventory', { method: 'DELETE' });
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to clear inventory");
                }
            }
        }

        // --- Delete Single Item ---
        async function deleteCurrentItem() {
            if (!currentItemId) return;

            if (confirm("Are you sure you want to delete this spool?")) {
                const res = await fetch(`/api/inventory/${currentItemId}`, { method: 'DELETE' });
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to delete item");
                }
            }
        }

        // --- Consume Spool (Mark as Used) ---
        async function consumeSpool() {
            if (!currentItemId) return;

            if (confirm("‚ö†Ô∏è Mark this spool as USED?\n\nThis will:\n- Move it to your usage history\n- Reduce inventory quantity by 1\n\nContinue?")) {
                const res = await fetch(`/api/inventory/${currentItemId}/consume`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();

                    // Show low stock warning if applicable
                    if (data.low_stock_warning) {
                        alert("‚ö†Ô∏è LOW STOCK WARNING\n\nYou now have only 1 unit of this filament remaining!");
                    }

                    window.location.reload();
                } else {
                    alert("Failed to mark spool as used");
                }
            }
        }

        // --- Modal Logic ---
        const modal = document.getElementById('detail-modal');
        const modalImg = document.getElementById('modal-img');

        function openModal(item) {
            currentItemId = item.id;

            // Populate Fields
            document.getElementById('modal-brand').textContent = item.brand;
            document.getElementById('modal-material-color').textContent = `${item.material} - ${item.color_name}`;
            document.getElementById('modal-code').textContent = item.filament_code ? `Code: ${item.filament_code}` : '';

            document.getElementById('modal-weight').textContent = `${item.weight_remaining_g}g`;
            document.getElementById('modal-qty').textContent = `x${item.quantity}`;

            document.getElementById('modal-diameter').textContent = `${item.diameter}mm`;
            document.getElementById('modal-temp').textContent = `${item.temp_nozzle}¬∞C`;
            document.getElementById('modal-location').textContent = item.location || 'Unassigned';
            document.getElementById('modal-date').textContent = item.date_added;

            // Image
            if (item.image_path) {
                modalImg.src = "/" + item.image_path;
            } else {
                modalImg.src = ""; // Placeholder?
            }
            modalImg.style.transform = "scale(1)"; // Reset zoom

            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function toggleZoom(img) {
            if (img.style.transform === "scale(2.5)") {
                img.style.transform = "scale(1)";
                img.style.cursor = "zoom-in";
            } else {
                img.style.transform = "scale(2.5)";
                img.style.cursor = "zoom-out";
            }
        }

        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // --- Filtering Logic (Existing) ---
        const searchInput = document.getElementById('search-input');
        const brandSelect = document.getElementById('filter-brand');
        const mateSelect = document.getElementById('filter-material');
        const colorSelect = document.getElementById('filter-color');
        const grid = document.getElementById('inventory-grid');
        const cards = document.querySelectorAll('.spool-card');
        const countLabel = document.getElementById('result-count');

        function filter() {
            const term = searchInput.value.toLowerCase();
            const brand = brandSelect.value;
            const mate = mateSelect.value;
            const color = colorSelect.value;
            let visible = 0;

            cards.forEach(card => {
                const cBrand = card.dataset.brand;
                const cMate = card.dataset.material;
                const cColor = card.dataset.color;
                const text = card.innerText.toLowerCase();

                let match = true;
                if (brand && cBrand !== brand) match = false;
                if (mate && cMate !== mate) match = false;
                if (color && cColor !== color) match = false;
                if (term && !text.includes(term)) match = false;

                if (match) {
                    card.style.display = '';
                    visible++;
                } else {
                    card.style.display = 'none';
                }
            });

            countLabel.textContent = `${visible} items`;
        }

        searchInput.addEventListener('input', filter);
        brandSelect.addEventListener('change', filter);
        mateSelect.addEventListener('change', filter);
        colorSelect.addEventListener('change', filter);

        // Init count
        filter();

        // --- Combine Mode Logic ---
        let combineMode = false;
        let selectedSpools = new Set();

        function toggleCombineMode() {
            combineMode = !combineMode;
            const checkboxes = document.querySelectorAll('.combine-checkbox');
            const btn = document.getElementById('combine-mode-btn');

            if (combineMode) {
                checkboxes.forEach(cb => cb.classList.remove('hidden'));
                btn.classList.add('bg-purple-700');
                btn.innerHTML = '‚úñ Exit Combine';
            } else {
                checkboxes.forEach(cb => {
                    cb.classList.add('hidden');
                    cb.querySelector('input').checked = false;
                });
                selectedSpools.clear();
                updateCombineActionBar();
                btn.classList.remove('bg-purple-700');
                btn.innerHTML = 'üîó Combine';
            }
        }

        function updateSelection(checkbox) {
            const spoolId = parseInt(checkbox.dataset.spoolId);
            if (checkbox.checked) {
                selectedSpools.add(spoolId);
            } else {
                selectedSpools.delete(spoolId);
            }
            updateCombineActionBar();
        }

        function updateCombineActionBar() {
            const actionBar = document.getElementById('combine-action-bar');
            const countSpan = document.getElementById('selected-count');

            if (selectedSpools.size >= 2) {
                actionBar.classList.remove('hidden');
                countSpan.textContent = `${selectedSpools.size} spools selected`;
            } else {
                actionBar.classList.add('hidden');
            }
        }

        async function combineSelected() {
            if (selectedSpools.size < 2) {
                alert('Please select at least 2 spools to combine');
                return;
            }

            if (!confirm(`Combine ${selectedSpools.size} spools into one?\n\nThis will:\n- Add up all quantities\n- Keep the most complete data\n- Delete duplicate entries\n\nContinue?`)) {
                return;
            }

            const res = await fetch('/api/inventory/combine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spool_ids: Array.from(selectedSpools) })
            });

            if (res.ok) {
                const data = await res.json();
                alert(`‚úÖ Successfully combined ${selectedSpools.size} spools!\nTotal quantity: ${data.total_quantity}`);
                window.location.reload();
            } else {
                const error = await res.json();
                alert(`Failed to combine spools: ${error.detail || 'Unknown error'}`);
            }
        }

        function cancelCombine() {
            toggleCombineMode();
        }
    </script>
</body>

</html>